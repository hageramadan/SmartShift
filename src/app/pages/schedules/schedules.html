<!-- schedules.html -->
<div class="min-h-screen bg-gray-50 p-6">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <h2 class="text-2xl font-bold text-pro">Schedules Management</h2>
    <button 
      class="bg-pro hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors"
      (click)="showCreateModal = true">
      <i class="fas fa-plus"></i>
      New Schedule
    </button>
  </div>

  <!-- Error Messages - إضافة z-index عالي -->
  <div *ngIf="error && !showCreateModal" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4 flex justify-between items-center relative z-50">
    <div>
      <strong class="font-bold">Error!</strong>
      <span class="ml-2"> {{ error }}</span>
    </div>
    <button type="button" class="text-red-700 hover:text-red-900" (click)="error = ''">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <!-- Error Messages داخل المودال -->
  <div *ngIf="error && showCreateModal" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-100 border border-red-400 text-red-700 px-6 py-4 rounded-lg shadow-lg z-[100] max-w-md w-full mx-4">
    <div class="flex justify-between items-center">
      <div class="flex items-center">
        <i class="fas fa-exclamation-triangle mr-2"></i>
        <div>
          <strong class="font-bold">Error!</strong>
          <span class="ml-2">{{ error }}</span>
        </div>
      </div>
      <button type="button" class="text-red-700 hover:text-red-900 ml-4" (click)="error = ''">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>

  <!-- Data Loading State -->
  <div *ngIf="dataLoading" class="text-center py-8">
    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    <p class="mt-3 text-gray-600">Loading departments, users, and sub-departments...</p>
  </div>

  <!-- Data Error State -->
  <div *ngIf="!dataLoading && (departments.length === 0 || users.length === 0 || subDepartments.length === 0)" 
       class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded-lg mb-4">
    <div class="flex justify-between items-center">
      <div>
        <strong class="font-bold">Warning!</strong>
        <span class="ml-2">Some data is missing. 
          <button (click)="refreshData()" class="underline ml-1">Click to reload</button>
        </span>
      </div>
      <button type="button" class="text-yellow-700 hover:text-yellow-900" (click)="refreshData()">
        <i class="fas fa-refresh"></i>
      </button>
    </div>
  </div>

  <!-- Filters Panel -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
      <h5 class="text-lg font-semibold text-pro flex items-center gap-2">
        <i class="fas fa-filter"></i>
        Filters
      </h5>
    </div>
    <div class="p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        
        <!-- Start Date -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
          <input 
            type="date" 
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            [(ngModel)]="filters.startDate"
            (change)="applyFilters()">
        </div>
        
        <!-- End Date -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
          <input 
            type="date" 
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            [(ngModel)]="filters.endDate"
            (change)="applyFilters()">
        </div>
        
        <!-- Department -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
          <select 
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            [(ngModel)]="filters.departmentId" 
            (change)="onDepartmentFilterChange()">
            <option value="">All Departments</option>
            <option *ngFor="let dept of departments" [value]="dept._id">
              {{ dept.name }}
            </option>
          </select>
        </div>
        
        <!-- Sub Department -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Sub Department</label>
          <select 
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            [(ngModel)]="filters.subDepartmentId"
            (change)="applyFilters()">
            <option value="">All Sub Departments</option>
            <option *ngFor="let subDept of filteredSubDepartments" [value]="subDept._id">
              {{ subDept.name }}
            </option>
          </select>
        </div>
        
        <!-- User -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">User</label>
          <select 
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            [(ngModel)]="filters.userId"
            (change)="applyFilters()">
            <option value="">All Users</option>
            <option *ngFor="let user of filteredUsers" [value]="user._id">
              {{ user.fullName }} ({{ user.employeeId }})
            </option>
          </select>
        </div>

        <!-- Shift -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Shift</label>
          <select 
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            [(ngModel)]="filters.shiftId"
            (change)="applyFilters()">
            <option value="">All Shifts</option>
            <option *ngFor="let shift of shifts" [value]="shift._id">
              {{ shift.shiftName }} ({{ shift.startTimeFormatted }} - {{ shift.endTimeFormatted }})
            </option>
          </select>
        </div>
      </div>
      <div class="flex gap-3 mt-6">
        <button 
          class="bg-pro hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          (click)="applyFilters()" 
          [disabled]="loading">
          <i class="fas fa-search"></i>
          Apply Filters
        </button>
        <button 
          class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg flex items-center gap-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          (click)="resetFilters()" 
          [disabled]="loading">
          <i class="fas fa-refresh"></i>
          Reset
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="text-center py-8">
    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    <p class="mt-3 text-gray-600">Loading schedules...</p>
  </div>

  <!-- Schedules Table -->
  <div *ngIf="!loading" class="bg-white rounded-lg shadow-sm border border-gray-200">
    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
      <h5 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
        <i class="fas fa-calendar-alt"></i>
        Schedules List
      </h5>
      <span class="text-sm text-gray-500">
        Showing {{ schedules.length }} of {{ pagination.totalFiltered }}
        (Total: {{ pagination.total }})
      </span>
    </div>
    
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sub-Department</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shift</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <tr *ngFor="let schedule of schedules" class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="font-semibold text-gray-900">{{ formatDate(schedule.date) }}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-10 w-10 bg-pro2 text-pro rounded-full flex items-center justify-center text-white font-semibold text-sm">
                  {{ getUserName(schedule.userId).charAt(0) }}
                </div>
                <div class="ml-4">
                  <div class="text-sm font-medium text-gray-900">{{ getUserName(schedule.userId) }}</div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-pro2 text-pro border border-blue-200">
                {{ getDepartmentName(schedule.departmentId) }}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800 border border-gray-200">
                {{ getSubDepartmentName(schedule.subDepartmentId) }}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="text-sm font-medium text-gray-900">{{ getShiftName(schedule.shiftId) }}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="text-sm text-gray-500">{{ getShiftTime(schedule.shiftId) }}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <div class="flex gap-2">
                <button 
                  (click)="updateSchedule(schedule)"
                  [title]="'Edit ' + getUserName(schedule.userId)"
                  [disabled]="loading"
                  class="text-pro disabled:opacity-50 disabled:cursor-not-allowed p-2 rounded-lg hover:bg-yellow-50 transition-colors">
                  <i class="fas fa-edit"></i>
                </button>
                <button 
                  (click)="deleteSchedule(schedule._id!)"
                  [title]="'Delete ' + getUserName(schedule.userId)"
                  [disabled]="loading"
                  class="text-red-600 hover:text-red-900 disabled:opacity-50 disabled:cursor-not-allowed p-2 rounded-lg hover:bg-red-50 transition-colors">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="schedules.length === 0">
            <td colspan="7" class="px-6 py-12 text-center">
              <div class="flex flex-col items-center justify-center text-gray-400">
                <i class="fas fa-inbox text-4xl mb-3"></i>
                <h5 class="text-lg font-medium text-gray-500 mb-2">No schedules found</h5>
                <p class="text-gray-400">Try adjusting your filters or create a new schedule</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div *ngIf="pagination.totalPages > 1" class="bg-gray-50 px-6 py-4 border-t border-gray-200">
      <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
        <div class="text-sm text-gray-500">
          Page {{ pagination.page }} of {{ pagination.totalPages }} • 
          Showing {{ schedules.length }} items
        </div>
        
        <div class="flex items-center gap-4">
          <nav class="flex gap-1">
            <button 
              (click)="goToPage(pagination.page - 1)"
              [disabled]="pagination.page === 1"
              class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
              <i class="fas fa-chevron-left"></i>
            </button>
            
            <button 
              *ngFor="let page of getPageNumbers()"
              (click)="goToPage(page)"
              [class]="pagination.page === page ? 
                'px-3 py-1 bg-pro2 text-pro font-semibold border border-pro  rounded-lg' : 
                'px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50'">
              {{ page }}
            </button>
            
            <button 
              (click)="goToPage(pagination.page + 1)"
              [disabled]="pagination.page === pagination.totalPages"
              class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed">
              <i class="fas fa-chevron-right"></i>
            </button>
          </nav>
          
          <select 
            class="px-3 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-100"
            [(ngModel)]="filters.limit" 
            (change)="applyFilters()">
            <option value="10">10 per page</option>
            <option value="25">25 per page</option>
            <option value="50">50 per page</option>
            <option value="100">100 per page</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Schedule Modal -->
  <div *ngIf="showCreateModal" class="fixed inset-0 bg-white/80 backdrop-blur-md flex items-center justify-center p-6 z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-2xl border border-gray-200/60 relative z-60">
      <div class="bg-pro2 text-pro px-6 py-4 rounded-t-2xl flex justify-between items-center">
        <h5 class="text-xl font-semibold flex items-center gap-3">
          <i class="fas fa-plus-circle"></i>
          Create New Schedule
        </h5>
        <button 
          type="button" 
          class="text-pro hover:text-blue-100 text-xl transition-colors"
          (click)="closeModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <div class="p-6">
        <form (ngSubmit)="createSchedule()" #scheduleForm="ngForm">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2 required">Date</label>
              <input 
                type="date" 
                class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
                [class.border-red-500]="formErrors.date"
                [(ngModel)]="newSchedule.date" 
                name="date" 
                required>
              <p *ngIf="formErrors.date" class="text-red-500 text-xs mt-1 flex items-center gap-1">
                <i class="fas fa-exclamation-circle"></i>
                {{ formErrors.date }}
              </p>
              <p class="text-xs text-gray-500 mt-2">Select schedule date</p>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2 required">Department</label>
              <select 
                class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
                [class.border-red-500]="formErrors.departmentId"
                [(ngModel)]="newSchedule.departmentId" 
                (change)="onModalDepartmentChange()" 
                name="departmentId" 
                required>
                <option value="">Select Department</option>
                <option *ngFor="let dept of departments" [value]="dept._id">
                  {{ dept.name }}
                </option>
              </select>
              <p *ngIf="formErrors.departmentId" class="text-red-500 text-xs mt-1 flex items-center gap-1">
                <i class="fas fa-exclamation-circle"></i>
                {{ formErrors.departmentId }}
              </p>
            </div>
          </div>
          
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2 required">Sub Department</label>
              <select 
                class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
                [class.border-red-500]="formErrors.subDepartmentId"
                [(ngModel)]="newSchedule.subDepartmentId" 
                name="subDepartmentId" 
                required>
                <option value="">Select Sub Department</option>
                <option *ngFor="let subDept of filteredSubDepartments" [value]="subDept._id">
                  {{ subDept.name }}
                </option>
              </select>
              <p *ngIf="formErrors.subDepartmentId" class="text-red-500 text-xs mt-1 flex items-center gap-1">
                <i class="fas fa-exclamation-circle"></i>
                {{ formErrors.subDepartmentId }}
              </p>
            </div>
            
            <div>
              <label class="block text-sm font-medium text-gray-700 mb-2 required">User</label>
              <select 
                class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
                [class.border-red-500]="formErrors.userId"
                [(ngModel)]="newSchedule.userId" 
                name="userId" 
                required>
                <option value="">Select User</option>
                <option *ngFor="let user of filteredUsers" [value]="user._id">
                  {{ user.fullName }} ({{ user.employeeId }})
                </option>
              </select>
              <p *ngIf="formErrors.userId" class="text-red-500 text-xs mt-1 flex items-center gap-1">
                <i class="fas fa-exclamation-circle"></i>
                {{ formErrors.userId }}
              </p>
            </div>
          </div>

          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-2 required">Shift</label>
            <select 
              class="w-full px-3 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-colors"
              [class.border-red-500]="formErrors.shiftId"
              [(ngModel)]="newSchedule.shiftId" 
              name="shiftId" 
              required>
              <option value="">Select Shift</option>
              <option *ngFor="let shift of shifts" [value]="shift._id">
                {{ shift.shiftName }} ({{ shift.startTimeFormatted }} - {{ shift.endTimeFormatted }})
              </option>
            </select>
            <p *ngIf="formErrors.shiftId" class="text-red-500 text-xs mt-1 flex items-center gap-1">
              <i class="fas fa-exclamation-circle"></i>
              {{ formErrors.shiftId }}
            </p>
            <p class="text-xs text-gray-500 mt-2">Choose shift timing</p>
          </div>
        </form>
      </div>
      
      <div class="bg-gray-50/80 px-6 py-4 rounded-b-2xl flex justify-end gap-3 border-t border-gray-200/60">
        <button 
          type="button" 
          class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 font-medium"
          (click)="closeModal()" 
          [disabled]="loading">
          <i class="fas fa-times"></i>
          Cancel
        </button>
        <button 
          type="button" 
          class="px-6 py-3 bg-pro text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 font-medium"
          (click)="createSchedule()" 
          [disabled]="!isValidSchedule(newSchedule) || loading">
          <i class="fas fa-save"></i>
          {{ loading ? 'Creating...' : 'Create Schedule' }}
        </button>
      </div>
    </div>
  </div>
</div>
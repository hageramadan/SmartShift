<!-- schedules.html -->
<div class="min-h-screen bg-gray-50 p-6">
  <!-- Header -->
  <div class="flex justify-between items-center mb-6">
    <div class="flex items-center gap-4">
      <h2 class="text-2xl font-bold text-pro">Schedules Management</h2>
      <button 
        (click)="refreshData()"
        class="text-gray-500 hover:text-pro transition-colors p-2 rounded-lg hover:bg-gray-100"
        title="Refresh Data">
        <i class="fas fa-refresh"></i>
      </button>
      <span class="text-sm bg-pro2 text-pro px-3 py-1 rounded-full font-medium">
        {{ isAdminUser ? 'Admin' : (isManagerUser ? 'Manager' : 'User') }}
      </span>
    </div>
    
    <!-- Create Button واحد -->
    <button 
      class="bg-pro hover:bg-blue-700 text-white px-6 py-3 rounded-xl flex items-center gap-3 transition-all duration-200 shadow-md hover:shadow-lg"
      (click)="openCreateModal()">
      <i class="fas fa-plus"></i>
      Create Schedule
    </button>
  </div>

  <!-- Error Messages -->
  <div *ngIf="error && !showCreateModal" class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg mb-4 flex justify-between items-center relative z-50">
    <div>
      <strong class="font-bold">Error!</strong>
      <span class="ml-2"> {{ error }}</span>
    </div>
    <button type="button" class="text-red-700 hover:text-red-900" (click)="error = ''">
      <i class="fas fa-times"></i>
    </button>
  </div>

  <!-- Error Messages داخل المودال -->
  <div *ngIf="error && showCreateModal" class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-red-100 border border-red-400 text-red-700 px-6 py-4 rounded-lg shadow-lg z-[100] max-w-md w-full mx-4">
    <div class="flex justify-between items-center">
      <div class="flex items-center">
        <i class="fas fa-exclamation-triangle mr-2"></i>
        <div>
          <strong class="font-bold">Error!</strong>
          <span class="ml-2">{{ error }}</span>
        </div>
      </div>
      <button type="button" class="text-red-700 hover:text-red-900 ml-4" (click)="error = ''">
        <i class="fas fa-times"></i>
      </button>
    </div>
  </div>

  <!-- Data Loading State -->
  <div *ngIf="dataLoading" class="text-center py-8">
    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    <p class="mt-3 text-gray-600">Loading departments, users, and sub-departments...</p>
  </div>

  <!-- Data Error State -->
  <div *ngIf="!dataLoading && (departments.length === 0 || users.length === 0 || subDepartments.length === 0)" 
       class="bg-yellow-100 border border-yellow-400 text-yellow-700 px-4 py-3 rounded-lg mb-4">
    <div class="flex justify-between items-center">
      <div>
        <strong class="font-bold">Warning!</strong>
        <span class="ml-2">Some data is missing. 
          <button (click)="refreshData()" class="underline ml-1">Click to reload</button>
        </span>
      </div>
      <button type="button" class="text-yellow-700 hover:text-yellow-900" (click)="refreshData()">
        <i class="fas fa-refresh"></i>
      </button>
    </div>
  </div>

  <!-- Filters Panel -->
  <div class="bg-white rounded-lg shadow-sm border border-gray-200 mb-6">
    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200">
      <h5 class="text-lg font-semibold text-pro flex items-center gap-2">
        <i class="fas fa-filter"></i>
        Filters
      </h5>
    </div>
    <div class="p-6">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        
        <!-- Start Date -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
          <input 
            type="date" 
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            [(ngModel)]="filters.startDate"
            (change)="applyFilters()">
        </div>
        
        <!-- End Date -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
          <input 
            type="date" 
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            [(ngModel)]="filters.endDate"
            (change)="applyFilters()">
        </div>
        
        <!-- Department - للمدير العام فقط -->
        <div *ngIf="isAdminUser">
          <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
          <select 
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            [(ngModel)]="filters.departmentId" 
            (change)="onDepartmentFilterChange()">
            <option value="">All Departments</option>
            <option *ngFor="let dept of departments" [value]="dept._id">
              {{ dept.name }}
            </option>
          </select>
        </div>
        
        <!-- Department - للمدير (عرض فقط) -->
        <div *ngIf="isManagerUser && !isAdminUser">
          <label class="block text-sm font-medium text-gray-700 mb-2">Department</label>
          <div class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-gray-100 text-gray-700">
            {{ departments[0]?.name || 'Loading...' }}
          </div>
          <input type="hidden" [(ngModel)]="filters.departmentId">
        </div>
        
        <!-- Sub Department -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Sub Department</label>
          <select 
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            [(ngModel)]="filters.subDepartmentId"
            (change)="applyFilters()">
            <option value="">All Sub Departments</option>
            <option *ngFor="let subDept of filteredSubDepartments" [value]="subDept._id">
              {{ subDept.name }}
            </option>
          </select>
        </div>
        
        <!-- User -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">User</label>
          <select 
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            [(ngModel)]="filters.userId"
            (change)="applyFilters()">
            <option value="">All Users</option>
            <option *ngFor="let user of filteredUsers" [value]="user._id">
              {{ user.fullName }} ({{ user.employeeId }})
            </option>
          </select>
        </div>

        <!-- Shift -->
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-2">Shift</label>
          <select 
            class="w-full px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
            [(ngModel)]="filters.shiftId"
            (change)="applyFilters()">
            <option value="">All Shifts</option>
            <option *ngFor="let shift of filteredShifts" [value]="shift._id">
              {{ shift.shiftName }} ({{ shift.shiftType }}) - {{ shift.startTimeFormatted }} - {{ shift.endTimeFormatted }}
            </option>
          </select>
        </div>
      </div>
      <div class="flex gap-3 mt-6">
        <button 
          class="bg-pro hover:bg-blue-700 text-white px-4 py-2 rounded-lg flex items-center gap-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          (click)="applyFilters()" 
          [disabled]="loading">
          <i class="fas fa-search"></i>
          Apply Filters
        </button>
        <button 
          class="bg-gray-200 hover:bg-gray-300 text-gray-700 px-4 py-2 rounded-lg flex items-center gap-2 transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
          (click)="resetFilters()" 
          [disabled]="loading">
          <i class="fas fa-refresh"></i>
          Reset
        </button>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="text-center py-8">
    <div class="inline-block animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600"></div>
    <p class="mt-3 text-gray-600">Loading schedules...</p>
  </div>

  <!-- Schedules Table -->
  <div *ngIf="!loading" class="bg-white rounded-lg shadow-sm border border-gray-200">
    <div class="bg-gray-50 px-6 py-4 border-b border-gray-200 flex justify-between items-center">
      <h5 class="text-lg font-semibold text-gray-800 flex items-center gap-2">
        <i class="fas fa-calendar-alt"></i>
        Schedules List
      </h5>
      <span class="text-sm text-gray-500">
        Showing {{ schedules.length }} of {{ pagination.totalFiltered }}
        (Total: {{ pagination.total }})
      </span>
    </div>
    
    <div class="overflow-x-auto">
      <table class="w-full">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">User</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Department</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sub-Department</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Shift</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Time</th>
            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
          </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-200">
          <tr *ngFor="let schedule of schedules" class="hover:bg-gray-50">
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="font-semibold text-gray-900">{{ formatDate(schedule.date) }}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex items-center">
                <div class="flex-shrink-0 h-10 w-10 bg-pro2 text-pro rounded-full flex items-center justify-center text-white font-semibold text-sm">
                  {{ getUserDisplay(schedule).charAt(0) }}
                </div>
                <div class="ml-4">
                  <div class="text-sm font-medium text-gray-900">{{ getUserDisplay(schedule) }}</div>
                  <div class="text-xs text-gray-500" *ngIf="getUserDisplay(schedule).includes('(')">
                    {{ schedule.userId?.substring(0, 8) }}...
                  </div>
                </div>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-pro2 text-pro border border-blue-200">
                {{ getDepartmentDisplay(schedule) }}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="inline-flex px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800 border border-gray-200">
                {{ getSubDepartmentDisplay(schedule) }}
              </span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <div class="flex flex-col">
                <span class="text-sm font-medium text-gray-900">{{ getShiftDisplay(schedule) }}</span>
                <span class="text-xs text-gray-500" *ngIf="getShiftTypeDisplay(schedule)">
                  {{ getShiftTypeDisplay(schedule) }}
                </span>
              </div>
            </td>
            <td class="px-6 py-4 whitespace-nowrap">
              <span class="text-sm text-gray-500">{{ getShiftTimeDisplay(schedule) }}</span>
            </td>
            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
              <div class="flex gap-2">
                <button 
                  (click)="updateSchedule(schedule)"
                  class="text-pro hover:text-blue-800 p-2 rounded-lg hover:bg-yellow-50 transition-colors"
                  title="Edit Schedule">
                  <i class="fas fa-edit"></i>
                </button>
                <button 
                  (click)="deleteSchedule(schedule._id!)"
                  class="text-red-600 hover:text-red-900 p-2 rounded-lg hover:bg-red-50 transition-colors"
                  title="Delete Schedule">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </td>
          </tr>
          <tr *ngIf="schedules.length === 0">
            <td colspan="7" class="px-6 py-12 text-center">
              <div class="flex flex-col items-center justify-center text-gray-400">
                <i class="fas fa-inbox text-4xl mb-3"></i>
                <h5 class="text-lg font-medium text-gray-500 mb-2">No schedules found</h5>
                <p class="text-gray-400">Try adjusting your filters or create a new schedule</p>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- Pagination -->
    <div *ngIf="pagination.totalPages > 1" class="bg-gray-50 px-6 py-4 border-t border-gray-200">
      <div class="flex flex-col sm:flex-row justify-between items-center gap-4">
        <div class="text-sm text-gray-500">
          Page {{ pagination.page }} of {{ pagination.totalPages }} • 
          Showing {{ schedules.length }} of {{ pagination.totalFiltered }} items
          (Total: {{ pagination.total }})
        </div>
        
        <div class="flex items-center gap-4">
          <nav class="flex gap-1">
            <button 
              (click)="goToPage(1)"
              [disabled]="pagination.page === 1"
              class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
              title="First Page">
              <i class="fas fa-angle-double-left"></i>
            </button>
            
            <button 
              (click)="goToPage(pagination.page - 1)"
              [disabled]="pagination.page === 1"
              class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
              title="Previous Page">
              <i class="fas fa-chevron-left"></i>
            </button>
            
            <button 
              *ngFor="let page of getPageNumbers()"
              (click)="page !== -1 && goToPage(page)"
              [class]="page === -1 ? 
                'px-3 py-1 border border-gray-300 rounded-lg cursor-default' :
                (pagination.page === page ? 
                  'px-3 py-1 bg-pro2 text-pro font-semibold border border-pro rounded-lg' : 
                  'px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50')"
              [disabled]="page === -1">
              {{ page === -1 ? '...' : page }}
            </button>
            
            <button 
              (click)="goToPage(pagination.page + 1)"
              [disabled]="pagination.page === pagination.totalPages"
              class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
              title="Next Page">
              <i class="fas fa-chevron-right"></i>
            </button>
            
            <button 
              (click)="goToPage(pagination.totalPages)"
              [disabled]="pagination.page === pagination.totalPages"
              class="px-3 py-1 border border-gray-300 rounded-lg hover:bg-gray-50 disabled:opacity-50 disabled:cursor-not-allowed"
              title="Last Page">
              <i class="fas fa-angle-double-right"></i>
            </button>
          </nav>
          
          <select 
            class="px-3 py-1 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-100 bg-white"
            [(ngModel)]="filters.limit" 
            (change)="applyFilters()">
            <option value="10">10 per page</option>
            <option value="25">25 per page</option>
            <option value="50">50 per page</option>
            <option value="100">100 per page</option>
          </select>
        </div>
      </div>
    </div>
  </div>

  <!-- Create Schedule Modal الموحد -->
  <div *ngIf="showCreateModal" class="fixed inset-0 bg-black/50 backdrop-blur-sm flex items-center justify-center p-4 z-50">
    <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl  relative z-60 max-h-[90vh] overflow-hidden flex flex-col">
      <!-- Header -->
      <div class="bg-pro text-white px-8 py-6 flex justify-between items-center">
        <div class="flex items-center gap-4">
          <div class="p-3 bg-white/20 rounded-xl">
            <i class="fas fa-calendar-plus text-2xl" *ngIf="!editingScheduleId"></i>
            <i class="fas fa-edit text-2xl" *ngIf="editingScheduleId"></i>
          </div>
          <div>
            <h5 class="text-2xl font-bold">
              {{ editingScheduleId ? 'Edit Schedule' : 'Create Schedule' }}
            </h5>
            <p class="text-blue-100 text-sm mt-1">
              {{ editingScheduleId ? 'Update schedule entry' : 'Add new schedule entries' }}
            </p>
          </div>
        </div>
        <button 
          type="button" 
          class="text-white hover:text-blue-100 text-xl transition-all duration-200 p-2 hover:bg-white/10 rounded-lg"
          (click)="closeModal()">
          <i class="fas fa-times"></i>
        </button>
      </div>
      
      <!-- Tabs -->
      <div class="bg-pro2  px-8 py-4">
        <div class="flex space-x-1">
          <button 
            (click)="setCreateMode('single')"
            class="px-6 py-3 rounded-lg font-medium transition-all duration-200 flex items-center gap-2"
            [class.bg-white]="createMode === 'single'"
            [class.text-pro]="createMode === 'single'"
            [class.shadow-sm]="createMode === 'single'"
            [class.text-gray-600]="createMode !== 'single'"
            [class.hover:text-pro]="createMode !== 'single'">
            <i class="fas fa-user"></i>
            Single Schedule
          </button>
          <button 
            (click)="setCreateMode('bulk')"
            class="px-6 py-3 rounded-lg font-medium transition-all duration-200 flex items-center gap-2"
            [class.bg-white]="createMode === 'bulk'"
            [class.text-pro]="createMode === 'bulk'"
            [class.shadow-sm]="createMode === 'bulk'"
            [class.text-gray-600]="createMode !== 'bulk'"
            [class.hover:text-pro]="createMode !== 'bulk'">
            <i class="fas fa-users"></i>
            Bulk Create
          </button>
        </div>
      </div>
      
      <!-- Content -->
      <div class="flex-1 overflow-y-auto p-8">
        
        <!-- Single Schedule Tab -->
        <div *ngIf="createMode === 'single'" class="space-y-6 animate-fade-in">
          <form #scheduleForm="ngForm">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2 required">Date</label>
                <input 
                  type="date" 
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  [class.border-red-500]="formErrors.date"
                  [(ngModel)]="newSchedule.date" 
                  name="date" 
                  required>
                <p *ngIf="formErrors.date" class="text-red-500 text-xs mt-1 flex items-center gap-1">
                  <i class="fas fa-exclamation-circle"></i>
                  {{ formErrors.date }}
                </p>
              </div>
              
              <!-- Department - للمدير العام فقط -->
              <div *ngIf="isAdminUser">
                <label class="block text-sm font-medium text-gray-700 mb-2 required">Department</label>
                <select 
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  [class.border-red-500]="formErrors.departmentId"
                  [(ngModel)]="newSchedule.departmentId" 
                  (change)="onModalDepartmentChange()" 
                  name="departmentId" 
                  required>
                  <option value="">Select Department</option>
                  <option *ngFor="let dept of departments" [value]="dept._id">
                    {{ dept.name }}
                  </option>
                </select>
                <p *ngIf="formErrors.departmentId" class="text-red-500 text-xs mt-1 flex items-center gap-1">
                  <i class="fas fa-exclamation-circle"></i>
                  {{ formErrors.departmentId }}
                </p>
              </div>

              <!-- Department - للمدير (عرض فقط) -->
              <div *ngIf="isManagerUser && !isAdminUser">
                <label class="block text-sm font-medium text-gray-700 mb-2 required">Department</label>
                <div class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-700">
                  {{ departments[0]?.name || 'Loading...' }}
                </div>
                <input type="hidden" [(ngModel)]="newSchedule.departmentId">
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2 required">Sub Department</label>
                <select 
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  [class.border-red-500]="formErrors.subDepartmentId"
                  [(ngModel)]="newSchedule.subDepartmentId" 
                  name="subDepartmentId" 
                  required>
                  <option value="">Select Sub Department</option>
                  <option *ngFor="let subDept of filteredSubDepartments" [value]="subDept._id">
                    {{ subDept.name }}
                  </option>
                </select>
                <p *ngIf="formErrors.subDepartmentId" class="text-red-500 text-xs mt-1 flex items-center gap-1">
                  <i class="fas fa-exclamation-circle"></i>
                  {{ formErrors.subDepartmentId }}
                </p>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700 mb-2 required">User</label>
                <select 
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  [class.border-red-500]="formErrors.userId"
                  [(ngModel)]="newSchedule.userId" 
                  name="userId" 
                  required>
                  <option value="">Select User</option>
                  <option *ngFor="let user of filteredUsers" [value]="user._id">
                    {{ user.fullName }} ({{ user.employeeId }})
                  </option>
                </select>
                <p *ngIf="formErrors.userId" class="text-red-500 text-xs mt-1 flex items-center gap-1">
                  <i class="fas fa-exclamation-circle"></i>
                  {{ formErrors.userId }}
                </p>
              </div>

              <div class="md:col-span-2">
                <label class="block text-sm font-medium text-gray-700 mb-2 required">Shift</label>
                <select 
                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                  [class.border-red-500]="formErrors.shiftId"
                  [(ngModel)]="newSchedule.shiftId" 
                  name="shiftId" 
                  required>
                  <option value="">Select Shift</option>
                  <option *ngFor="let shift of shifts" [value]="shift._id">
                    {{ shift.shiftName }} ({{ shift.shiftType }}) - {{ shift.startTimeFormatted }} - {{ shift.endTimeFormatted }}
                  </option>
                </select>
                <p *ngIf="formErrors.shiftId" class="text-red-400 text-xs mt-1 flex items-center gap-1">
                  <i class="fas fa-exclamation-circle"></i>
                  {{ formErrors.shiftId }}
                </p>
              </div>
            </div>
          </form>
        </div>

        <!-- Bulk Create Tab -->
        <div *ngIf="createMode === 'bulk'" class="space-y-6 animate-fade-in">
          <!-- Step 1: Date Selection -->
          <div *ngIf="bulkCreateStep === 1" class="space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <!-- Date Range -->
              <div class="bg-gray-50 rounded-xl p-6 border border-gray-200">
                <h6 class="font-semibold text-gray-800 mb-4 flex items-center gap-2">
                  <i class="fas fa-calendar-alt text-pro"></i>
                  Select Date Range
                </h6>
                <div class="grid grid-cols-1 gap-4">
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Start Date</label>
                    <input 
                      type="date" 
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                      [(ngModel)]="dateRange.start"
                      (change)="onDateRangeChange()">
                  </div>
                  <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">End Date</label>
                    <input 
                      type="date" 
                      class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                      [(ngModel)]="dateRange.end"
                      (change)="onDateRangeChange()">
                  </div>
                </div>
                <button 
                  type="button"
                  class="w-full mt-4 bg-pro text-white px-4 py-3 rounded-lg flex items-center justify-center gap-2 transition-all duration-200 font-medium"
                  (click)="generateDateRange()"
                  [disabled]="!dateRange.start || !dateRange.end">
                  <i class="fas fa-calendar-plus"></i>
                  Generate Dates
                </button>
              </div>

              <!-- Selected Dates -->
              <div class="bg-white rounded-xl p-6 border border-gray-200" *ngIf="selectedDates.length > 0">
                <div class="flex justify-between items-center mb-4">
                  <h6 class="font-semibold text-gray-800 flex items-center gap-2">
                    <i class="fas fa-list-check text-blue-600"></i>
                    Selected Dates ({{ bulkCreateData.dates.length }})
                  </h6>
                  <button 
                    type="button"
                    class="text-sm text-blue-600 hover:text-blue-700 font-medium"
                    (click)="toggleAllDates()">
                    {{ bulkCreateData.dates.length === selectedDates.length ? 'Deselect All' : 'Select All' }}
                  </button>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-3 gap-2 max-h-48 overflow-y-auto">
                  <label *ngFor="let date of selectedDates" 
                         class="flex items-center gap-3 p-3 rounded-lg border transition-all cursor-pointer"
                         [class.border-blue-500]="bulkCreateData.dates.includes(date)"
                         [class.bg-blue-50]="bulkCreateData.dates.includes(date)"
                         [class.border-gray-200]="!bulkCreateData.dates.includes(date)"
                         [class.bg-white]="!bulkCreateData.dates.includes(date)">
                    <input 
                      type="checkbox" 
                      [checked]="bulkCreateData.dates.includes(date)"
                      (change)="toggleDate(date)"
                      class="rounded text-blue-600 focus:ring-blue-500">
                    <span class="text-sm font-medium">{{ formatDate(date) }}</span>
                  </label>
                </div>
              </div>
            </div>

            <p *ngIf="bulkFormErrors.dates" class="text-red-500 text-sm flex items-center gap-2 p-3 bg-red-50 rounded-lg">
              <i class="fas fa-exclamation-circle"></i>
              {{ bulkFormErrors.dates }}
            </p>
          </div>

          <!-- Step 2: User and Settings Selection -->
          <div *ngIf="bulkCreateStep === 2" class="space-y-6">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
              <!-- Settings -->
              <div class="space-y-6">
                <!-- Department - للمدير العام فقط -->
                <div *ngIf="isAdminUser">
                  <label class="block text-sm font-medium text-gray-700 mb-3 required">Department</label>
                  <select 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                    [(ngModel)]="bulkCreateData.departmentId" 
                    (change)="onBulkDepartmentChange()">
                    <option value="">Select Department</option>
                    <option *ngFor="let dept of departments" [value]="dept._id">
                      {{ dept.name }}
                    </option>
                  </select>
                </div>

                <!-- Department - للمدير (عرض فقط) -->
                <div *ngIf="isManagerUser && !isAdminUser">
                  <label class="block text-sm font-medium text-gray-700 mb-3 required">Department</label>
                  <div class="w-full px-4 py-3 border border-gray-300 rounded-lg bg-gray-100 text-gray-700">
                    {{ departments[0]?.name || 'Loading...' }}
                  </div>
                  <input type="hidden" [(ngModel)]="bulkCreateData.departmentId">
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-3 required">Sub Department</label>
                  <select 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                    [(ngModel)]="bulkCreateData.subDepartmentId">
                    <option value="">Select Sub Department</option>
                    <option *ngFor="let subDept of filteredSubDepartments" [value]="subDept._id">
                      {{ subDept.name }}
                    </option>
                  </select>
                </div>

                <div>
                  <label class="block text-sm font-medium text-gray-700 mb-3 required">Shift</label>
                  <select 
                    class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent transition-all"
                    [(ngModel)]="bulkCreateData.shiftId">
                    <option value="">Select Shift</option>
                    <option *ngFor="let shift of shifts" [value]="shift._id">
                      {{ shift.shiftName }} ({{ shift.shiftType }}) - {{ shift.startTimeFormatted }} - {{ shift.endTimeFormatted }}
                    </option>
                  </select>
                </div>
              </div>

              <!-- Users Selection -->
              <div class="bg-white rounded-xl p-6 border border-gray-200">
                <div class="flex justify-between items-center mb-4">
                  <label class="block text-sm font-medium text-gray-700 required">
                    Select Users ({{ bulkCreateData.userIds.length }} selected)
                  </label>
                  <button 
                    type="button"
                    class="text-sm text-pro font-medium"
                    (click)="toggleAllUsers()">
                    {{ bulkCreateData.userIds.length === filteredUsers.length ? 'Deselect All' : 'Select All' }}
                  </button>
                </div>
                <div class="max-h-64 overflow-y-auto space-y-2">
                  <div *ngIf="filteredUsers.length === 0" class="text-center text-gray-500 py-8">
                    <i class="fas fa-users text-3xl mb-3 text-gray-300"></i>
                    <p>Please select a department first</p>
                  </div>
                  <label *ngFor="let user of filteredUsers" 
                         class="flex items-center gap-4 p-3 rounded-lg border transition-all cursor-pointer"
                         [class.border-blue-500]="bulkCreateData.userIds.includes(user._id!)"
                         [class.bg-blue-50]="bulkCreateData.userIds.includes(user._id!)"
                         [class.border-gray-200]="!bulkCreateData.userIds.includes(user._id!)"
                         [class.bg-white]="!bulkCreateData.userIds.includes(user._id!)">
                    <input 
                      type="checkbox" 
                      [checked]="bulkCreateData.userIds.includes(user._id!)"
                      (change)="toggleUser(user._id!)"
                      class="rounded text-pro focus:ring-2 ">
                    <div class="flex-1">
                      <div class="text-sm font-medium text-gray-900">{{ user.fullName }}</div>
                      <div class="text-xs text-gray-500">{{ user.employeeId }}</div>
                    </div>
                  </label>
                </div>
              </div>
            </div>
          </div>

          <!-- Step 3: Confirmation -->
          <div *ngIf="bulkCreateStep === 3" class="space-y-6">
            <div class="bg-pro2  rounded-xl p-6">
              <h6 class="font-semibold text-pro mb-4 flex items-center gap-2">
                <i class="fas fa-check-circle"></i>
                Ready to Create Schedules
              </h6>
              <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
                <div>
                  <p class="text-pro mb-2"><strong>Dates:</strong> {{ bulkCreateData.dates.length }} selected</p>
                  <p class="text-pro mb-2"><strong>Users:</strong> {{ bulkCreateData.userIds.length }} selected</p>
                  <p class="text-pro"><strong>Shift:</strong> {{ getSelectedShiftName() }}</p>
                </div>
                <div class="bg-white rounded-lg p-4 border border-blue-200">
                  <p class="text-pro font-semibold text-center text-lg">
                    Total: {{ bulkCreateData.dates.length * bulkCreateData.userIds.length }} Schedules
                  </p>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Footer -->
      <div class="bg-gray-50/80 px-8 py-6 border-t border-gray-200/60 flex justify-between items-center">
        <!-- Bulk Navigation -->
        <div *ngIf="createMode === 'bulk'">
          <button 
            type="button" 
            class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 font-medium"
            (click)="previousStep()"
            [disabled]="bulkCreateStep === 1">
            <i class="fas fa-arrow-left"></i>
            Previous
          </button>
        </div>
        
        <div class="flex items-center gap-3 ml-auto">
          <button 
            type="button" 
            class="px-6 py-3 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400 transition-all duration-200 flex items-center gap-2 font-medium"
            (click)="closeModal()">
            <i class="fas fa-times"></i>
            Cancel
          </button>

          <!-- Bulk Next Button -->
          <button 
            type="button" 
            class="px-8 py-3 bg-pro text-white rounded-lg hover:bg-blue-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 font-medium shadow-md hover:shadow-lg"
            (click)="nextStep()"
            *ngIf="createMode === 'bulk' && bulkCreateStep < 3"
            [disabled]="!canProceedToNextStep()">
            Next
            <i class="fas fa-arrow-right"></i>
          </button>

          <!-- Create Button -->
          <button 
            type="button" 
            class="px-8 py-3 bg-pro text-white rounded-lg hover:bg-blue-700 transition-all duration-200 disabled:opacity-50 disabled:cursor-not-allowed flex items-center gap-2 font-medium shadow-md hover:shadow-lg"
            (click)="createSchedule()"
            *ngIf="(createMode === 'single') || (createMode === 'bulk' && bulkCreateStep === 3)"
            [disabled]="(createMode === 'single' && !isValidSchedule(newSchedule)) || (createMode === 'bulk' && !isBulkFormValid()) || loading">
            <i class="fas fa-save" [class.fa-spin]="loading"></i>
            {{ 
              loading ? (editingScheduleId ? 'Updating...' : 'Creating...') : 
              (createMode === 'single' ? 
                (editingScheduleId ? 'Update Schedule' : 'Create Schedule') : 
                'Create All Schedules') 
            }}
          </button>
        </div>
      </div>
    </div>
  </div>
</div>